# План работ (Task Board) — rust-certbot

Документ описывает цели, дорожную карту, пошаговые задачи, критерии приёмки и риски для реализации проекта `rust-certbot`.

## Цели
- **ACME-клиент**: получение и автоматическое обновление SSL‑сертификатов (Let's Encrypt/совместимые).
- **HTTP‑01 challenge**: обработка через встроенный веб‑сервер (Actix) и/или через Nginx‑подобный конфиг.
- **Хранилище сертификатов**: структура, резервные копии, ротация, защита ключей.
- **Прокси**: простой reverse‑proxy/терминация SSL (встроенно) как делают на Nginx.
- **Контейнеризация**: проект работает в Docker; файлы не раскидываются по системе без необходимости.
- **Наблюдаемость**: логи, метрики, простые health‑checks.
- **Тесты и документация**: модульные, интеграционные; гайды по эксплуатации.

## Дорожная карта (Milestones)

### M0. База и структура (готовность к разработке)
- [x] Репозиторий и базовая структура
- [x] Пример Nginx‑подобного конфига `config/simple.conf`
- [x] Раздел в `README.md` со списком шагов для Nginx
- [ ] Dockerfile + docker-compose для локального запуска
- [ ] Выравнивание путей: единая точка конфигурации путей (`config.toml`)

Критерии приёмки:
- Сборка проходит: `cargo build --release`
- Контейнер собирается и запускается локально
- Пути к webroot/certs настраиваются через конфиг/переменные среды

### M1. Конфигурация и домены
- [ ] Парсинг `simple.conf` (сервер, домены, acme, certificates, proxy)
- [ ] Валидация доменных записей (имя домена, каталог webroot, порт прокси)
- [ ] Единый слой конфигурации путей (host/container paths, volumes)

Критерии приёмки:
- При старте логируется перечень доменов и целевых каталогов
- Ошибочные конфиги приводят к понятной ошибке и коду выхода ≠ 0

### M2. HTTP‑01 challenge handler (Actix)
- [ ] Эндпоинт: `GET /.well-known/acme-challenge/{token}`
- [ ] Обслуживание файлов из `./web/letsencrypt` (или из пути из `config.toml`)
- [ ] Простая страница `/health` и `/version`

Критерии приёмки:
- Файл, положенный в `web/letsencrypt`, читается по HTTP без 404/403
- `curl /health` → 200 OK; `curl /version` → JSON с версией

### M3. ACME‑клиент и управление сертификатами
- [ ] Выбор библиотеки (варианты): `acme-lib`, `rcgen` + кастомный ACME‑флоу, или обёртка над внешней утилитой
- [ ] Регистрация аккаунта (email, staging/prod)
- [ ] Создание/подтверждение ордера для домена (HTTP‑01)
- [ ] Выпуск сертификата, сохранение ключа и цепочки
- [ ] Структура хранилища: `cert/<domain>/fullchain.pem`, `privkey.pem`, `chain.pem`
- [ ] Резервные копии: `backups/` с ротацией

Критерии приёмки:
- Для домена `example.com` можно получить валидный серт в staging
- Файлы появляются в `cert/<domain>/`, права доступа на ключ ограничены

### M4. Планировщик и автообновление
- [ ] Периодическая проверка срока действия (например, каждые N часов)
- [ ] Порог обновления (из `renewal_threshold_days`)
- [ ] Пере‑выпуск серта и атомарная замена файлов
- [ ] Логирование событий обновления

Критерии приёмки:
- При приближении срока действия < threshold → запускается обновление
- Безостановочное обновление (перезапуск воркера, без падений основного сервиса)

### M5. Прокси и интеграция
- [ ] Встроенный reverse‑proxy (опционально): `/service` → `proxy_pass` из конфига
- [ ] Интеграция с Nginx (референс): `config/simple.conf`
- [ ] Заголовок `X-Cert-Renewal` (per‑domain) для наблюдаемости

Критерии приёмки:
- Прокси корректно проксирует на заданный upstream
- В ответах присутствует `X-Cert-Renewal` для соответствующего домена

### M6. Наблюдаемость и эксплуатация
- [ ] Конфигурируемые уровни логирования
- [ ] Простейшие метрики (выдача дат/счётчик обновлений)
- [ ] Readiness/ liveness пробы

Критерии приёмки:
- Логи читаемы; метрики/пробы возвращают ожидаемые значения

### M7. Тестирование и CI
- [ ] Юнит‑тесты: конфиг, парсинг, утилиты дат
- [ ] Интеграционные тесты: HTTP‑01 хэндлер, файловая система
- [ ] E2E (опционально с Pebble — тестовый ACME‑сервер в docker)
- [ ] CI: build/test/format/clippy

Критерии приёмки:
- `cargo test` зелёный локально и в CI
- Форматирование и clippy без критичных предупреждений

### M8. Документация и релиз
- [ ] Обновлённый `README.md` с разделами по установке/запуску/интеграции
- [ ] Этот документ `task.MD` актуализирован
- [ ] Семантические версии релизов, changelog

Критерии приёмки:
- Полный гайд по запуску, включая Docker и Nginx‑интеграцию
- Тег релиза, загруженные артефакты (если применимо)

---

## Технические детали исполнения

### 1) Пути и тома
- Базовые каталоги (по проекту):
  - `./web/letsencrypt` — HTTP‑01 файлы
  - `./cert/<domain>` — сертификаты и ключи
  - `./backups` — резервные копии
- В Docker: пробросить тома в контейнер так, чтобы пути из `config.toml` совпадали с путями в приложении и/или Nginx.

### 2) Nginx‑подобный конфиг (`config/simple.conf`)
- Per‑domain дата обновления через `map`:
```nginx
map $host $cert_renewal_date {
    default "-";
    your-domain.com "YYYY-MM-DD";
}
```
- Включать файл в `http { }` контексте и использовать `add_header X-Cert-Renewal $cert_renewal_date always;` внутри `server { }`.

### 3) Безопасность ключей
- Права доступа `600` для приватных ключей
- Разделение прав пользователя/процесса (в контейнере — non‑root при возможности)
- Не логировать приватные данные/ключи

### 4) Планировщик
- Отдельный асинхронный воркер (tokio task)
- Джиттер к интервалам, чтобы избежать одновременных обновлений множества доменов

### 5) Резервное копирование
- Перед заменой сертификатов — бэкап со штампом времени
- Ротация старых бэкапов по количеству/возрасту

---

## Риски и меры
- **Сложности ACME‑протокола**: использовать проверенную библиотеку или Pebble для отладки.
- **Несоответствие путей в Docker: стандартизовать пути через конфиг и переменные среды.
- **Права на файлы**: провал валидации ACME из‑за недоступных challenge‑файлов; добавить проверки на старте.
- **Сроки/лимиты Let’s Encrypt**: использовать `staging = true` на этапе тестов.

---

## Быстрые команды
```bash
# Локальная сборка и тесты
cargo fmt && cargo clippy && cargo test

# Проверка Nginx‑конфига (если используется)
nginx -t && nginx -s reload

# Пример подготовки каталогов
mkdir -p ./web/letsencrypt ./cert/example.com ./backups
```

---

## Ближайшие задачи (Next Up)
- [ ] Добавить Dockerfile и docker-compose с пробросом каталогов `web`, `cert`, `backups`
- [ ] Реализовать чтение `config.toml` и логику доменов
- [ ] Реализовать HTTP‑01 хэндлер и health‑routes в Actix
- [ ] Подключить/выбрать ACME‑библиотеку и провести первый выпуск в staging
- [ ] Добавить планировщик автообновления и логирование событий 